<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>버스 관제 시스템</title>
  <!-- React UMD + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    /** ---------- 아이콘 (React 컴포넌트, className 지원) ---------- */
    const IconUsers = ({ className = "" }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"
           strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="m22 21-3-3m0-6a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
      </svg>
    );
    const IconPhone = ({ className = "" }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"
           strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
      </svg>
    );
    const IconCheck = ({ className = "" }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"
           strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22,4 12,14.01 9,11.01"/>
      </svg>
    );
    const IconClock = ({ className = "" }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"
           strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12,6 12,12 16,14"/>
      </svg>
    );
    const IconAlert = ({ className = "" }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"
           strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
    );

    /** ---------- 유틸 ---------- */
    const formatTimeAgo = (date) => {
      if (!date) return "없음";
      const now = new Date();
      const d = new Date(date);
      const diffMs = now - d;
      const mins = Math.floor(diffMs / 60000);
      if (mins < 1) return "방금 전";
      if (mins < 60) return `${mins}분 전`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `${hours}시간 전`;
      return `${Math.floor(hours / 24)}일 전`;
    };

    const formatTimeLeft = (expiresAt) => {
      if (!expiresAt) return "-";
      const diff = new Date(expiresAt) - new Date();
      if (diff <= 0) return "만료됨";
      const m = Math.floor(diff / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      return `${m}:${String(s).padStart(2,"0")}`;
    };

    /** ---------- API 헬퍼 ---------- */
    const createApi = (token, onUnauthorized) => async (url, options = {}) => {
      const res = await fetch(url, {
        ...options,
        headers: {
          "Content-Type": "application/json",
          ...(options.headers || {}),
          ...(token ? { Authorization: `Bearer ${token}` } : {})
        }
      });
      if (res.status === 401) {
        onUnauthorized?.();
        throw new Error("Unauthorized");
      }
      if (!res.ok) {
        const txt = await res.text().catch(()=> "");
        throw new Error(`API ${res.status} ${res.statusText} ${txt}`);
      }
      return res.json();
    };

    /** ---------- 로그인 폼 ---------- */
    const LoginForm = ({ onSuccess }) => {
      const [phone, setPhone] = useState("+821080097964");
      const [code, setCode] = useState("");
      const [step, setStep] = useState("phone"); // "phone" | "code"
      const [loading, setLoading] = useState(false);

      const requestCode = async () => {
        setLoading(true);
        try {
          const res = await fetch("/auth/request-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: "관리자", phone })
          });
          const data = await res.json();
          if (data.success) {
            setStep("code");
            if (data.devCode) alert(`개발 모드 - 인증번호: ${data.devCode}`);
          } else {
            alert(`인증번호 요청 실패: ${data.error || "알 수 없는 오류"}`);
          }
        } catch (e) {
          alert("네트워크 오류");
        } finally {
          setLoading(false);
        }
      };

      const verifyCode = async () => {
        setLoading(true);
        try {
          const res = await fetch("/auth/verify-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: "관리자", phone, code })
          });
          const data = await res.json();
          // 백엔드 응답 구조 유연 처리: user 또는 driver 키
          const user = data.user || data.driver;
          if (data.success && user?.role === "admin" && data.token) {
            onSuccess(data.token);
          } else {
            alert("로그인 실패. 관리자 권한 또는 코드 확인 필요.");
          }
        } catch (e) {
          alert("로그인 중 오류가 발생했습니다.");
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center">
          <div className="w-full max-w-md bg-white rounded-xl shadow p-8">
            <h2 className="text-2xl font-bold mb-6 text-center">관리자 로그인</h2>

            {step === "phone" ? (
              <div className="space-y-4">
                <input
                  type="text"
                  value={phone}
                  onChange={(e)=> setPhone(e.target.value)}
                  placeholder="전화번호 (+8210...)"
                  className="w-full p-3 border border-gray-300 rounded-lg"
                  disabled={loading}
                />
                <button
                  onClick={requestCode}
                  disabled={loading || !phone}
                  className="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                >
                  {loading ? "요청 중..." : "인증번호 요청"}
                </button>
              </div>
            ) : (
              <div className="space-y-4">
                <input
                  type="text"
                  value={code}
                  onChange={(e)=> setCode(e.target.value)}
                  placeholder="인증번호 입력"
                  className="w-full p-3 border border-gray-300 rounded-lg"
                  disabled={loading}
                />
                <button
                  onClick={verifyCode}
                  disabled={loading || !code}
                  className="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                >
                  {loading ? "확인 중..." : "로그인"}
                </button>
                <button
                  onClick={()=> setStep("phone")}
                  className="w-full bg-gray-200 text-gray-800 p-3 rounded-lg hover:bg-gray-300"
                  disabled={loading}
                >
                  다시 요청
                </button>
              </div>
            )}
          </div>
        </div>
      );
    };

    /** ---------- 메인 패널 ---------- */
    const AdminPanel = () => {
      const [activeTab, setActiveTab] = useState("dashboard"); // "dashboard" | "calls" | "drivers"
      const [token, setToken] = useState(() => localStorage.getItem("adminToken"));
      const [calls, setCalls] = useState([]);
      const [drivers, setDrivers] = useState([]);
      const [dashboard, setDashboard] = useState(null);
      const [statusMsg, setStatusMsg] = useState("실시간 업데이트 중");

      const handleAuthed = (t) => {
        localStorage.setItem("adminToken", t);
        setToken(t);
      };

      const logout = () => {
        localStorage.removeItem("adminToken");
        setToken(null);
        setCalls([]);
        setDrivers([]);
        setDashboard(null);
      };

      const api = useMemo(() => createApi(token, logout), [token]);

      useEffect(() => {
        if (!token) return;
        let cancelled = false;

        const fetchAll = async () => {
          try {
            const [c, d, db] = await Promise.all([
              api("/admin/calls"),
              api("/admin/drivers"),
              api("/admin/dashboard")
            ]);
            if (cancelled) return;
            setCalls(Array.isArray(c) ? c : c?.rows || []);
            setDrivers(Array.isArray(d) ? d : d?.rows || []);
            setDashboard(db || null);
            setStatusMsg("실시간 업데이트 중");
          } catch (e) {
            if (!cancelled) setStatusMsg("연결 문제 발생, 재시도 중…");
            // 401은 api가 logout 처리함
          }
        };

        fetchAll();
        const id = setInterval(fetchAll, 5000);
        return () => { cancelled = true; clearInterval(id); };
      }, [token, api]);

      if (!token) return <LoginForm onSuccess={handleAuthed} />;

      /** ---- 탭들 ---- */
      const Dashboard = () => {
        const activeWorking = drivers.filter(d => d.active && d.today_status === "WORKING").length;
        const openCalls = calls.filter(c => c.state === "OPEN").length;
        const closedCalls = calls.filter(c => c.state === "CLOSED").length;

        return (
          <div className="space-y-6">
            <h2 className="text-2xl font-bold text-gray-900">관제 대시보드</h2>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="bg-white p-6 rounded-lg shadow">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">활성 기사</p>
                    <p className="text-2xl font-semibold text-gray-900">{activeWorking}</p>
                  </div>
                  <IconUsers className="h-8 w-8 text-blue-500"/>
                </div>
              </div>

              <div className="bg-white p-6 rounded-lg shadow">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">진행중 호출</p>
                    <p className="text-2xl font-semibold text-gray-900">{openCalls}</p>
                  </div>
                  <IconPhone className="h-8 w-8 text-red-500"/>
                </div>
              </div>

              <div className="bg-white p-6 rounded-lg shadow">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">오늘 완료</p>
                    <p className="text-2xl font-semibold text-gray-900">{closedCalls}</p>
                  </div>
                  <IconCheck className="h-8 w-8 text-green-500"/>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow">
              <div className="p-6 border-b border-gray-200">
                <h3 className="text-lg font-medium text-gray-900">실시간 활동</h3>
              </div>
              <div className="p-6">
                <div className="space-y-3">
                  <div className="flex items-start space-x-3">
                    <IconAlert className="h-5 w-5 text-red-500 flex-shrink-0"/>
                    <div>
                      <p className="text-sm text-gray-900">시스템 상태: {statusMsg}</p>
                      {dashboard?.last_event && (
                        <p className="text-xs text-gray-500">
                          마지막 이벤트: {dashboard.last_event} · {formatTimeAgo(dashboard.last_event_time)}
                        </p>
                      )}
                    </div>
                  </div>
                  {/* 필요시 최근 로그 리스트 등 추가 가능 */}
                </div>
              </div>
            </div>
          </div>
        );
      };

      const CallManagement = () => (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold text-gray-900">긴급 호출 관리</h2>
            <div className="flex gap-2">
              <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                진행중: {calls.filter(c => c.state === "OPEN").length}
              </span>
              <span className="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm">
                완료: {calls.filter(c => c.state === "CLOSED").length}
              </span>
            </div>
          </div>

          <div className="grid gap-4">
            {calls.map(call => (
              <div
                key={call.id}
                className={`p-6 rounded-lg border-2 ${call.state === "OPEN" ? "border-red-200 bg-red-50" : "border-gray-200 bg-gray-50"}`}
              >
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900">
                      {call.route_id}번 버스 긴급 호출
                    </h3>
                    <p className="text-gray-600">
                      {call.service_date} | {call.start_time} - {call.end_time}
                    </p>
                  </div>
                  <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                    call.state === "OPEN" ? "bg-red-100 text-red-800" : "bg-green-100 text-green-800"
                  }`}>
                    {call.state === "OPEN" ? "진행중" : "완료"}
                  </span>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                  <div className="text-center p-3 bg-white rounded border">
                    <div className="text-2xl font-bold text-gray-900">{call.total_tokens}</div>
                    <div className="text-sm text-gray-600">총 발송</div>
                  </div>
                  <div className="text-center p-3 bg-white rounded border">
                    <div className="text-2xl font-bold text-blue-600">{call.responded_tokens}</div>
                    <div className="text-sm text-gray-600">응답</div>
                  </div>
                  <div className="text-center p-3 bg-white rounded border">
                    <div className="text-2xl font-bold text-gray-500">
                      {(call.total_tokens || 0) - (call.responded_tokens || 0)}
                    </div>
                    <div className="text-sm text-gray-600">미응답</div>
                  </div>
                  <div className="text-center p-3 bg-white rounded border">
                    <div className={`text-2xl font-bold ${call.state === "OPEN" ? "text-red-600" : "text-green-600"}`}>
                      {call.state === "OPEN" ? formatTimeLeft(call.expires_at) : "완료"}
                    </div>
                    <div className="text-sm text-gray-600">
                      {call.state === "OPEN" ? "남은시간" : "상태"}
                    </div>
                  </div>
                </div>

                {call.winner_name && (
                  <div className="flex items-center gap-2 p-3 bg-green-100 rounded">
                    <IconCheck className="h-5 w-5 text-green-600"/>
                    <span className="font-medium text-green-800">
                      {call.winner_name}님이 배정되었습니다
                    </span>
                  </div>
                )}
              </div>
            ))}

            {calls.length === 0 && (
              <div className="text-center py-12 text-gray-500">
                현재 진행중인 긴급 호출이 없습니다
              </div>
            )}
          </div>
        </div>
      );

      const DriverManagement = () => (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold text-gray-900">기사 관리</h2>
            <div className="flex gap-2">
              <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                활성: {drivers.filter(d => d.active).length}
              </span>
              <span className="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm">
                총 인원: {drivers.length}
              </span>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">기사 정보</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">연락처</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">권한</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">오늘 상태</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">최종 접속</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {drivers.map(d => (
                  <tr key={d.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center">
                        <div className={`h-10 w-10 rounded-full flex items-center justify-center text-white font-medium ${d.role === "admin" ? "bg-purple-500" : "bg-blue-500"}`}>
                          {(d.name || "?").charAt(0)}
                        </div>
                        <div className="ml-4">
                          <div className="text-sm font-medium text-gray-900">{d.name || "-"}</div>
                          <div className="text-sm text-gray-500">ID: {d.id}</div>
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{d.phone || "-"}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        d.role === "admin" ? "bg-purple-100 text-purple-800" : "bg-blue-100 text-blue-800"
                      }`}>
                        {d.role === "admin" ? "관리자" : "기사"}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        d.today_status === "WORKING" ? "bg-green-100 text-green-800" : "bg-gray-100 text-gray-800"
                      }`}>
                        {d.today_status === "WORKING" ? "근무중" : "휴무"}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      <div className="flex items-center gap-1">
                        <IconClock className="h-4 w-4"/>
                        <span>{formatTimeAgo(d.last_seen)}</span>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );

      return (
        <div className="min-h-screen">
          {/* 상단 바 */}
          <div className="bg-white shadow">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center py-6">
                <h1 className="text-3xl font-bold text-gray-900">버스 관제 시스템</h1>
                <div className="flex items-center gap-4">
                  <span className="flex items-center gap-2 text-sm text-gray-600">
                    <span className="w-3 h-3 bg-green-400 rounded-full animate-pulse"></span>
                    실시간 연결됨
                  </span>
                  <button
                    onClick={logout}
                    className="text-sm text-red-600 hover:text-red-800"
                  >
                    로그아웃
                  </button>
                </div>
              </div>

              {/* 탭 */}
              <div className="border-b border-gray-200">
                <nav className="-mb-px flex space-x-8">
                  {[
                    { key: "dashboard", label: "대시보드", icon: IconUsers },
                    { key: "calls", label: "호출관리", icon: IconPhone },
                    { key: "drivers", label: "기사관리", icon: IconUsers }
                  ].map(({ key, label, icon: Icon }) => (
                    <button
                      key={key}
                      onClick={() => setActiveTab(key)}
                      className={`whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm flex items-center gap-2
                        ${activeTab === key
                          ? "border-blue-500 text-blue-600"
                          : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`}
                    >
                      <Icon className="h-4 w-4"/>
                      <span>{label}</span>
                    </button>
                  ))}
                </nav>
              </div>
            </div>
          </div>

          {/* 본문 */}
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {activeTab === "dashboard" && <Dashboard/>}
            {activeTab === "calls" && <CallManagement/>}
            {activeTab === "drivers" && <DriverManagement/>}
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<AdminPanel/>);
  </script>
</body>
</html>
